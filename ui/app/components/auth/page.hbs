{{!
  Copyright (c) HashiCorp, Inc.
  SPDX-License-Identifier: BUSL-1.1
~}}

{{#if this.mfaErrors}}
  <div class="has-top-margin-xxl" data-test-mfa-error>
    <EmptyState
      @title="Unauthorized"
      @message="Multi-factor authentication is required, but failed. Go back and try again, or contact your administrator."
      @icon="alert-circle"
      @bottomBorder={{true}}
      @subTitle={{join ". " this.mfaErrors}}
      class="is-shadowless"
    >
      <Hds::Button @text="Go back" @icon="chevron-left" @color="tertiary" {{on "click" this.onMfaErrorDismiss}} />
    </EmptyState>
  </div>
{{else}}
  <SplashPage>
    <:header>
      {{#if @oidcProviderQueryParam}}
        <div class="box is-shadowless is-flex-v-centered" data-test-auth-logo>
          <LogoEdition aria-label="Sign in with Hashicorp Vault" />
        </div>
      {{else}}
        <div class="is-flex-v-centered has-bottom-margin-xxl">
          <div class="brand-icon-large">
            <Icon @name="vault" @size="24" @stretched={{true}} />
          </div>
        </div>
        <div class="is-flex-row">
          {{#if this.mfaAuthData}}
            <Hds::Button
              @text="Back to login"
              @icon="arrow-left"
              @isIconOnly={{true}}
              @color="tertiary"
              {{on "click" (fn (mut this.mfaAuthData) null)}}
            />
          {{/if}}
          <h1 class="title is-3">
            {{if this.mfaAuthData "Authenticate" "Sign in to Vault"}}
          </h1>
        </div>
      {{/if}}
    </:header>

    <:content>
      {{#if this.mfaAuthData}}
        <Mfa::MfaForm
          @clusterId={{@cluster.id}}
          @authData={{this.mfaAuthData}}
          @onSuccess={{this.onMfaSuccess}}
          @onError={{fn (mut this.mfaErrors)}}
        />
      {{else}}
        {{! This would be a separate component, leaving here just to show auth component POC }}
        {{#if (or this.selectedAuthMethod this.authTabs)}}
          <Auth::FormTemplate
            @wrappedToken={{@wrappedToken}}
            @cluster={{@cluster}}
            {{! set namespace in service instead of pass to child? }}
            {{!-- @namespace={{@namespaceQueryParam}} --}}
            @authType={{this.selectedAuthMethod}}
            @onSuccess={{this.onAuthResponse}}
          >
            <:namespace>
              {{#if this.version.isEnterprise}}
                <Auth::NamespaceInput
                  @updateNamespace={{this.handleNamespaceUpdate}}
                  @value={{@namespace}}
                  @hvdManagedNamespace={{this.flags.hvdManagedNamespaceRoot}}
                  @disabled={{@oidcProviderQueryParam}}
                />
              {{/if}}
            </:namespace>
            <:options>
              {{! "Back" button shows when user has clicked "Sign in with other methods" }}
              {{#if (and this.showAllMethods this.authTabs)}}
                <Hds::Button
                  @text="Back"
                  {{on "click" (fn (mut this.showAllMethods) false)}}
                  class="has-left-margin-l"
                  @color="tertiary"
                  @icon="arrow-left"
                />
              {{/if}}
            </:options>
            <:tabs>
              {{#if (and this.authTabs (not this.showAllMethods))}}
                <Auth::Tabs
                  @authTabs={{this.authTabs}}
                  @displayNameHelper={{this.displayName}}
                  @onTabClick={{this.handleAuthSelect}}
                  @selectedAuthMethod={{this.selectedAuthMethod}}
                  @selectedTabIndex={{this.selectedTabIndex}}
                />
              {{else}}
                <div class="has-left-margin-l has-bottom-margin-l has-right-margin-l">
                  {{! select changes this.selectedAuthType }}
                  <Hds::Form::Select::Field name="selectedAuthMethod" {{on "input" this.handleAuthSelect}} as |F|>
                    <F.Label class="has-top-padding-l">Auth method</F.Label>
                    <F.Options>
                      {{#each this.availableMethodTypes as |type|}}
                        <option selected={{eq this.selectedAuthMethod type}} value={{type}}>
                          {{this.displayName type}}
                        </option>
                      {{/each}}
                    </F.Options>
                  </Hds::Form::Select::Field>
                  {{#if (not-eq @selectedAuthMethod "token")}}
                    <Hds::Form::TextInput::Field name="path" as |F|>
                      <F.Label class="has-top-padding-l">Mount path</F.Label>
                    </Hds::Form::TextInput::Field>
                  {{/if}}
                </div>
              {{/if}}
            </:tabs>
          </Auth::FormTemplate>
        {{/if}}
        {{#unless this.showAllMethods}}
          <Hds::Button
            @isInline={{true}}
            @text="Sign in with other methods"
            @color="tertiary"
            @icon="arrow-right"
            @iconPosition="trailing"
            {{on "click" (fn (mut this.showAllMethods) true)}}
            class="has-left-margin-m has-bottom-margin-l"
          />
        {{/unless}}
      {{/if}}
    </:content>

    <:footer>
      <div class="has-short-padding">
        <p class="help has-text-grey-dark" data-test-auth-helptext>
          {{#if @oidcProviderQueryParam}}
            Once you log in, you will be redirected back to your application. If you require login credentials, contact your
            administrator.
          {{else}}
            Contact your administrator for login credentials.
          {{/if}}
        </p>
      </div>
    </:footer>
  </SplashPage>
{{/if}}